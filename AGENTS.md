never commit anything unless asked by the user precisely

NEVER run rm -rf on ANY folder outside of project directory! NEVER even run things like rm -rf ~/.bun/install/cache

always use kebab case for new filenames. never use uppercase letters in filenames

ALWAYS use the right package manager for ts repos. you can see the right one based on lock files like bun.lock. for example bun publish instead of npm publish.

if you need to create scripts always prefer typescript over bash or js. never create new files in js unless strictly required.


## planning

when user asks you to plan he wants you to read all relevant files and create a concrete plan with steps: sections where you describe what files you would update and what tests you would add to validate the new changes.

NEVER output a plan where you "plan" to read files or plan to explore the codebase. the goal of a plan is to do these things before starting the implementation part. you have to explore the codebase, read files, validate assumptions BEFORE showing the user the plan in chat. 

if there are multiple ways to implement the changes show an high level summary of each approach before showing the full plan.

## playwriter

ALWAYS use locally installed playwriter without npx or bunx. this way we will use the locally running playwriter instead which can have required fixes and other improvements. 

## git

NEVER rewrite git history. NEVER amend commits unless asked. NEVER restore or revert unless specifically asked. NEVER call git reset. prefer merge over rebase or squash

when creating a new branch, always check if you're in a fork (origin and upstream remotes are different). if so, switch to upstream's default branch first:

```bash
# check if upstream exists and differs from origin
git remote -v

# if in a fork, get default branch name and switch to it
DEFAULT_BRANCH=$(gh repo view --json defaultBranchRef --jq '.defaultBranchRef.name')
git fetch upstream
git checkout upstream/$DEFAULT_BRANCH
```

never amend commits or rewrite git history

write very detailed commit messages. feel free to include diagrams and other markdown, tables, lists, quotes, etc. 

### searching past commits

use 3 approaches to find commits that updated certain code

```sh

#search in the commit message
git log --grep="search term"

# Search for commits that added or removed a string
git log -S "search term"

# Search with regex among diff of commits
git log -G "regex pattern"
```

Use all three passing variable names and function names in search strings

## github

before creating any gh pr or issue output the title and body in chat and ask for confirmation first

if you open PRs or issues with gh cli first check what is the correct commit, title and body format for the pr or issue. if there is not any don't use headings in the body (it looks like AI slop). never use markdown headings in PR unless that is the PR template and standard practice

after creating a pr always print the pr url to the user, then watch for ci to complete successfully using command like

```bash
gh pr checks --watch --fail-fast
```

to handle PR review comments:

```bash
# view reviews and get thread IDs
gh pr-review review view 42 -R owner/repo --unresolved

# reply to a review comment
gh pr-review comments reply 42 -R owner/repo \
  --thread-id PRRT_kwDOAAABbcdEFG12 \
  --body "Fixed in latest commit"

# resolve a thread
gh pr-review threads resolve 42 -R owner/repo --thread-id PRRT_kwDOAAABbcdEFG12
```

NEVER use git to revert files to previous state if you did not create those files yourself! there can be user changes in files you touched, if you revert those changes the user will be very upset!

Never submit pending reviews with placeholder messages like "Reviewing suggestions". If a pending review blocks comment replies, dismiss it instead of submitting with generic text comment.

## updating PRs and issues

always update existing PRs, issues, or comments instead of recreating them. use `gh pr edit` or `gh issue edit` to update title/body.

when checking if there is already a pr for current branch always check upstream first

never close a PR or issue without explicit user confirmation. if something needs to change, update it instead of closing and recreating.

## planning

when planning a task, first read all files relevant to the plan:

- the main files you'll be modifying
- files they import (dependencies)
- files that import them (importees/dependents)

this gives you the full picture of the codebase before writing the plan. after gathering context, use the prune tool to cleanup read tool calls that ended up not being needed, saving context usage for the actual implementation

read all files you need! do not try to save context window by not reading files. instead DO read them and then prune them later if not relevant.

## updating AGENTS.md files

before updating agents instructions files always double check that they are not generated by other commands, in that case you should never edit them directly. this is common, just read the first 10 lines to see if the AGENTS.md tells it is being generated by another script. if this is the case look at the root package.json for the script that generates it, usually there are other files that have project specific instructions you can edit instead. like PROJECTNAME_AGENTS.md

## tasks

when using task tool always be as detailed as possible on what you want: list goal of task, overall goal of session, requirements for task, tips for subagent, overall scope of project and why task is being used.

## reading images

ALWAYS use the task tool for reading/analyzing images. never read images directly with the read tool as images consume a lot of context window space.

when analyzing an image, pass a detailed description in the task prompt of what you want to know. be specific about what aspects to examine and what information to return.

example: if detecting clipping issues in a screenshot, ask the task to describe in detail whether any UI elements are clipped, cut off, or overflowing their containers, and to report the specific locations and severity of any issues found.

the subagent will read the image and return only the relevant textual findings, saving significant context.

## docs .md files

if user asks you to create .md files with findings always put them in a docs folder and not at root level or in src

## background processes

for running dev servers and other long running commands use tmux background sessions with names

## compounding engineering

if some particular planning architecture/bug debugging session/code implementation required a lot of effort or back and forth always add the learned knowledge, lessons & tips in comments in the relevant code: explain shortcuts or preferences to never make the same mistakes again.

you can add it at the top of the file in a comment if there is no specific portion of the code where the comment fits

if you want to add some knowledge about the overall codebase write it in a ./docs/ .md file with title & description frontmatter and reference it in AGENTS.md (first checking if there is a \*\_AGENTS.md that is specific about this project that is not generated)

## testing

.toMatchInlineSnapshot is the preferred way to write tests, added before any expect call. leave them empty the first time, update them with -u. check git diff for the test file every time you update them with -u to make sure the snapshots are expected and correct.

NEVER use mocks in tests. NEVER mock modules.

# opensrc

to read source code of npm packages or repos you can do:

```sh
bunx opensrc npmpackagename
opensrc github:owner/repo
opensrc owner/repo@v1.0.0
opensrc owner/repo#main
```


this will download them in a local ./opensrc folder

this is preferable over manually cloning repos in tmp or using gitchamber

# git worktrees

when user asks you to create new worktree for the session do this

```sh
git worktree add ../{reponame}-{branchname} -b {branchname} upstream/main
```

sometimes upstream/main is different, check what is the default branch first, could be not main

## kimaki

for kimaki.xyz commands always use global kimaki instead of npx kimaki, it will use the local version of kimaki cli with latest changes

after I ask to git push call the tool kimaki_archive_thread so the thread is removed from Discord sidebar and completed tasks are not shown in left sidebar.

## committing only certain hunks

sometimes other agents added unrelated changes in git diffs

when committing you should first see the git diff, then if the files only have your changes commit those files only with

```bash
git commit path/to/file1 path/to/file2 -m "commit message"
```

If instead there are other changes in those same files you can use critique hunks command to stage only some portion of changes and leave unrelated changes unstaged and non committed

```
# List all unstaged hunks with stable IDs
critique hunks list

# List staged hunks
critique hunks list --staged

# Filter by file pattern
critique hunks list --filter "src/**/*.ts"

# Stage specific hunks by ID
critique hunks add 'src/main.ts:@-10,6+10,7'

# Stage multiple hunks
critique hunks add 'src/main.ts:@-10,6+10,7' 'src/utils.ts:@-5,3+5,4'

```

> always use global critique command instead of using bunx so you use the latest version with latest changes, critique in PATH is using the local version of critique with latest changes and fixes
